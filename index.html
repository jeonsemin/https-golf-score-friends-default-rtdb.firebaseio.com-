<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¹œêµ¬ë“¤ ê³¨í”„ ìŠ¤ì½”ì–´ ë­í‚¹ (ê³µìœ  ë²„ì „)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    body {
      background: #0f172a;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      padding: 24px 16px;
    }
    .app {
      width: 100%;
      max-width: 980px;
      background: #020617;
      border-radius: 20px;
      padding: 18px 16px 24px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 22px 50px rgba(0, 0, 0, 0.6);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .title-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .title {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 600;
    }
    .subtitle {
      font-size: 13px;
      color: #9ca3af;
    }
    .header-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    .room-info {
      font-size: 12px;
      color: #9ca3af;
    }
    .btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
      font-size: 12px;
      padding: 6px 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .btn.primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      border-color: transparent;
      font-weight: 600;
    }
    .btn.danger {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }
    .btn.small {
      padding: 4px 10px;
      font-size: 11px;
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.8);
    }
    .layout-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.4fr);
      gap: 14px;
    }
    @media (max-width: 860px) {
      .layout-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    .card {
      background: rgba(15, 23, 42, 0.95);
      border-radius: 16px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 12px 12px 14px;
      margin-bottom: 8px;
    }
    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      gap: 8px;
    }
    .card-title {
      font-size: 14px;
      font-weight: 600;
    }
    .card-sub {
      font-size: 11px;
      color: #9ca3af;
    }
    .input-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 6px;
    }
    .field {
      flex: 1;
      min-width: 150px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    label {
      font-size: 11px;
      color: #9ca3af;
    }
    .input, .select {
      width: 100%;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(75, 85, 99, 0.9);
      background: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
      font-size: 13px;
      outline: none;
      transition: all 0.15s ease;
    }
    .input:focus, .select:focus {
      border-color: #22c55e;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.4);
    }
    .helper {
      font-size: 11px;
      color: #6b7280;
      margin-top: 2px;
    }
    .error-text {
      font-size: 11px;
      color: #fecaca;
      margin-top: 2px;
    }
    .updated {
      font-size: 10px;
      color: #6b7280;
    }
    .top3-list {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .top3-item {
      flex: 1;
      min-width: 100px;
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: radial-gradient(circle at top left, rgba(34, 197, 94, 0.22), transparent 55%),
                  rgba(15, 23, 42, 0.95);
      padding: 8px 9px 9px;
      font-size: 11px;
    }
    .top3-rank {
      font-weight: 600;
      opacity: 0.8;
      margin-bottom: 2px;
    }
    .top3-name {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .top3-score {
      font-size: 12px;
      color: #bbf7d0;
    }
    .summary-row {
      margin-top: 8px;
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      font-size: 11px;
    }
    .summary-pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #9ca3af;
    }
    .badge-small {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      margin-left: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td {
      padding: 8px 8px;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: rgba(15, 23, 42, 1);
      color: #9ca3af;
      border-bottom: 1px solid rgba(31, 41, 55, 1);
      font-size: 11px;
      font-weight: 500;
    }
    td {
      border-bottom: 1px solid rgba(30, 41, 59, 0.9);
    }
    tbody tr:nth-child(even) {
      background: rgba(15, 23, 42, 0.9);
    }
    tbody tr:hover {
      background: rgba(30, 64, 175, 0.5);
    }
    .align-right {
      text-align: right;
    }
    .rank-cell {
      font-weight: 600;
    }
    .name-main {
      font-size: 12px;
      font-weight: 600;
    }
    .name-sub {
      font-size: 11px;
      color: #9ca3af;
    }
    .score-good {
      color: #bbf7d0;
      font-weight: 600;
    }
    .score-mid {
      color: #facc15;
      font-weight: 600;
    }
    .score-bad {
      color: #fca5a5;
      font-weight: 600;
    }
    .empty {
      padding: 14px 8px;
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
    }
    .room-warning {
      font-size: 11px;
      color: #facc15;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="header">
      <div class="title-wrap">
        <div class="title">
          ğŸŒï¸ ì¹œêµ¬ë“¤ ê³¨í”„ ë­í‚¹
          <span class="badge">ê³µìœ  ë²„ì „</span>
        </div>
        <div class="subtitle">
          ë°© ì½”ë“œë§Œ ë§ì¶”ë©´, ì¹´í†¡ë°© ì¹œêµ¬ë“¤ì´ ì „ë¶€ ê°™ì€ ë­í‚¹ ë³´ë“œë¥¼ í•¨ê»˜ ì‚¬ìš©í•©ë‹ˆë‹¤.
        </div>
      </div>
      <div class="header-actions">
        <div class="room-info" id="roomInfo">ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”</div>
      </div>
    </header>

    <!-- ë°© ì„ íƒ ì¹´ë“œ -->
    <section class="card" style="margin-bottom:16px;">
      <div class="card-title-row">
        <div>
          <div class="card-title">ë°© ì„ íƒ</div>
          <div class="card-sub">ì¹´í†¡ë°©ë§ˆë‹¤ í•˜ë‚˜ì˜ ë°© ì½”ë“œë¥¼ ì •í•´ì„œ ê°™ì´ ì“°ë©´ ë©ë‹ˆë‹¤. (ì˜ˆ: "ì–‘ì”ë””ë™í˜¸íšŒ")</div>
        </div>
      </div>
      <div class="input-row">
        <div class="field">
          <label for="roomCodeInput">ë°© ì½”ë“œ</label>
          <input id="roomCodeInput" class="input" type="text" placeholder="ì˜ˆ: ì–‘ì”ë””ë™í˜¸íšŒ, 2026ë´„ëª¨ì„ ..." />
          <div class="helper">ê°™ì€ ì½”ë“œë¥¼ ì…ë ¥í•œ ì‚¬ëŒë¼ë¦¬ ë°ì´í„°ê°€ ê³µìœ ë©ë‹ˆë‹¤.</div>
        </div>
      </div>
      <button class="btn primary" id="btnJoinRoom">ì´ ë°©ìœ¼ë¡œ ì…ì¥</button>
      <div class="room-warning">â€» ë°© ì½”ë“œë¥¼ ë°”ê¾¸ë©´ ë‹¤ë¥¸ ë°© ë°ì´í„°ê°€ ë³´ì…ë‹ˆë‹¤. ì¹´í†¡ë°©ì—ì„œ ì½”ë“œ í•˜ë‚˜ ì •í•´ì„œ ëª¨ë‘ ë˜‘ê°™ì´ ì…ë ¥í•˜ì„¸ìš”.</div>
      <div id="roomError" class="error-text" style="display:none;"></div>
    </section>

    <main class="layout-grid" id="mainContent" style="opacity:0.4; pointer-events:none;">
      <!-- ì™¼ìª½: í”Œë ˆì´ì–´ ì¶”ê°€ + ìŠ¤ì½”ì–´ ì…ë ¥ + Top3 -->
      <section>
        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">í”Œë ˆì´ì–´ ì¶”ê°€</div>
              <div class="card-sub">ê°™ì´ ì¹˜ëŠ” ì¹œêµ¬ë“¤ ì´ë¦„ì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”. (ë°© ì „ì²´ ê³µìœ )</div>
            </div>
          </div>

          <div class="input-row">
            <div class="field">
              <label for="playerNameInput">ì´ë¦„ / ë‹‰ë„¤ì„</label>
              <input id="playerNameInput" class="input" type="text" placeholder="ì˜ˆ: ì² ìˆ˜, ì˜í¬, John..." />
            </div>
          </div>
          <button class="btn primary small" id="btnAddPlayer">í”Œë ˆì´ì–´ ì¶”ê°€</button>
          <div class="helper">ì´ë¦„ë§Œ ê°„ë‹¨íˆ ì ì–´ë„ ë©ë‹ˆë‹¤. (í•œ ë²ˆ ì¶”ê°€í•˜ë©´ ë°©ì˜ ëª¨ë“  ì‚¬ëŒì´ ë³¼ ìˆ˜ ìˆì–´ìš”)</div>
          <div id="playerError" class="error-text" style="display:none;"></div>
        </div>

        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">ìŠ¤ì½”ì–´ ì…ë ¥</div>
              <div class="card-sub">ë¼ìš´ë“œ ëë‚  ë•Œë§ˆë‹¤ ë‚ ì§œÂ·ì¥ì†Œì™€ í•¨ê»˜ ì ìˆ˜ë¥¼ ê¸°ë¡í•´ë‘ì„¸ìš”. (ì‹¤ì‹œê°„ ê³µìœ )</div>
            </div>
            <div class="updated" id="updatedLabel">-</div>
          </div>

          <div class="input-row">
            <div class="field">
              <label for="playerSelect">í”Œë ˆì´ì–´</label>
              <select id="playerSelect" class="select">
                <option value="">ë¨¼ì € í”Œë ˆì´ì–´ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</option>
              </select>
            </div>
          </div>

          <div class="input-row">
            <div class="field">
              <label for="roundDateInput">ë¼ìš´ë“œ ë‚ ì§œ</label>
              <input id="roundDateInput" class="input" type="date" />
              <div class="helper">ì…ë ¥ ì•ˆ í•˜ë©´ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìë™ ê¸°ë¡ë©ë‹ˆë‹¤.</div>
            </div>
            <div class="field">
              <label for="roundLabelInput">ë¼ìš´ë“œ ì´ë¦„ / ì¥ì†Œ</label>
              <input id="roundLabelInput" class="input" type="text" placeholder="ì˜ˆ: ë™ë„¤ ê³¨í”„ì¥, ë¼ìš´ë“œ1 ..." />
              <div class="helper">ì˜ˆ: 2026-03-01 ë™ë„¤ ê³¨í”„ì¥ ê°™ì´ ë©”ëª¨ìš©ìœ¼ë¡œ ì‚¬ìš©.</div>
            </div>
          </div>

          <div class="input-row">
            <div class="field">
              <label for="scoreInput">ì´ë²ˆ ë¼ìš´ë“œ ìŠ¤ì½”ì–´ (íƒ€ìˆ˜)</label>
              <input id="scoreInput" class="input" type="number" min="50" max="200" placeholder="ì˜ˆ: 72" />
              <div class="helper">ëŒ€ëµ 50~120 ì‚¬ì´ ì •ë„ë¡œ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤. (ì œí•œì€ ì—†ìŒ)</div>
            </div>
          </div>

          <button class="btn primary small" id="btnAddScore">ìŠ¤ì½”ì–´ ê¸°ë¡</button>
          <div id="scoreError" class="error-text" style="display:none;"></div>
        </div>

        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">
                Top 3
                <span class="badge-small">í‰ê·  ìŠ¤ì½”ì–´ ê¸°ì¤€</span>
              </div>
              <div class="card-sub">ì§€ê¸ˆê¹Œì§€ ì…ë ¥ëœ ìŠ¤ì½”ì–´ ê¸°ì¤€ ìƒìœ„ 3ëª…ì…ë‹ˆë‹¤.</div>
            </div>
          </div>
          <div id="top3Container">
            <div class="empty">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í”Œë ˆì´ì–´ë¥¼ ì¶”ê°€í•˜ê³  ìŠ¤ì½”ì–´ë¥¼ ì…ë ¥í•´ë³´ì„¸ìš”.</div>
          </div>
        </div>
      </section>

      <!-- ì˜¤ë¥¸ìª½: ë­í‚¹ í…Œì´ë¸” -->
      <section>
        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">ë­í‚¹</div>
              <div class="card-sub">í‰ê·  ìŠ¤ì½”ì–´ê°€ ë‚®ì„ìˆ˜ë¡ ìˆœìœ„ê°€ ë†’ìŠµë‹ˆë‹¤. (ìµœê·¼ ë¼ìš´ë“œ ì •ë³´ í‘œì‹œ)</div>
            </div>
            <div class="card-sub" id="summaryInfo">-</div>
          </div>

          <div style="overflow-x:auto;">
            <table>
              <thead>
                <tr>
                  <th style="width:40px;">ìˆœìœ„</th>
                  <th>í”Œë ˆì´ì–´</th>
                  <th class="align-right">í‰ê· </th>
                  <th class="align-right">ë² ìŠ¤íŠ¸</th>
                  <th class="align-right">ë¼ìš´ë“œ ìˆ˜</th>
                </tr>
              </thead>
              <tbody id="rankingBody">
              </tbody>
            </table>
          </div>
          <div id="emptyRanking" class="empty" style="display:none;">
            ì•„ì§ ì•„ë¬´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì™¼ìª½ì—ì„œ í”Œë ˆì´ì–´ì™€ ìŠ¤ì½”ì–´ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
          </div>
          <div style="margin-top:6px; display:flex; justify-content:space-between; align-items:center;">
            <button class="btn danger small" id="btnResetRoom">ì´ ë°© ë°ì´í„° ì´ˆê¸°í™”</button>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Firebase SDK (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // 1) ì—¬ê¸° firebaseConfigì— ë³¸ì¸ í”„ë¡œì íŠ¸ ê°’ ë¶™ì—¬ë„£ê¸°
    // Firebase ì½˜ì†”ì—ì„œ ì›¹ ì•± ë“±ë¡í–ˆì„ ë•Œ ë‚˜ì˜¨ ì½”ë“œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
    const firebaseConfig = {
      // TODO: https://golf-score-friends-default-rtdb.firebaseio.com/
      // ì˜ˆì‹œ:
      // apiKey: "XXXXXXXXXXXX",
      // authDomain: "XXXXXXXXXXXX.firebaseapp.com",
      // databaseURL: "https://XXXXXXXXXXXX-default-rtdb.asia-southeast1.firebasedatabase.app",
      // projectId: "XXXXXXXXXXXX",
      // storageBucket: "XXXXXXXXXXXX.appspot.com",
      // messagingSenderId: "XXXXXXXXXXXX",
      // appId: "XXXXXXXXXXXX"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentRoomCode = "";
    let players = []; // {id, name, rounds:[{score, date, label}]}

    // ---- ìœ í‹¸ ---------------------------------------------------------------
    function normalizeRounds(rounds) {
      if (!Array.isArray(rounds)) return [];
      return rounds.map(r => {
        if (typeof r === "number") {
          return { score: r, date: "", label: "" };
        }
        if (r && typeof r === "object" && "score" in r) {
          return {
            score: Number(r.score),
            date: r.date || "",
            label: r.label || ""
          };
        }
        return null;
      }).filter(Boolean);
    }

    function calcAvg(rounds) {
      const normalized = normalizeRounds(rounds);
      if (!normalized.length) return 0;
      const sum = normalized.reduce((a, b) => a + (b.score || 0), 0);
      return sum / normalized.length;
    }

    function calcBest(rounds) {
      const normalized = normalizeRounds(rounds);
      if (!normalized.length) return 0;
      return Math.min(...normalized.map(r => r.score));
    }

    function getTodayISO() {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth() + 1).padStart(2, "0");
      const dd = String(now.getDate()).padStart(2, "0");
      return `${yyyy}-${mm}-${dd}`;
    }

    function classifyScore(score) {
      if (score === 0) return "";
      if (score <= 72) return "score-good";
      if (score <= 85) return "score-mid";
      return "score-bad";
    }

    function getRankedPlayers() {
      const list = players.map(p => {
        const norm = normalizeRounds(p.rounds);
        const avg = calcAvg(norm);
        const best = calcBest(norm);
        return {
          ...p,
          rounds: norm,
          avgScore: avg,
          bestScore: best,
          roundsCount: norm.length
        };
      });

      list.sort((a, b) => {
        if (a.roundsCount === 0 && b.roundsCount === 0) return 0;
        if (a.roundsCount === 0) return 1;
        if (b.roundsCount === 0) return -1;
        if (a.avgScore === b.avgScore) {
          return a.name.localeCompare(b.name, "ko-KR");
        }
        return a.avgScore - b.avgScore;
      });

      return list;
    }

    function updateUpdatedLabel() {
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      updatedLabel.textContent = `ë§ˆì§€ë§‰ ì…ë ¥ Â· ${hh}:${mm}`;
    }

    // ---- DOM ì°¸ì¡° ----------------------------------------------------------
    const roomCodeInput = document.getElementById("roomCodeInput");
    const btnJoinRoom = document.getElementById("btnJoinRoom");
    const roomInfo = document.getElementById("roomInfo");
    const roomError = document.getElementById("roomError");

    const mainContent = document.getElementById("mainContent");

    const playerNameInput = document.getElementById("playerNameInput");
    const btnAddPlayer = document.getElementById("btnAddPlayer");
    const playerSelect = document.getElementById("playerSelect");
    const scoreInput = document.getElementById("scoreInput");
    const btnAddScore = document.getElementById("btnAddScore");
    const roundDateInput = document.getElementById("roundDateInput");
    const roundLabelInput = document.getElementById("roundLabelInput");

    const playerError = document.getElementById("playerError");
    const scoreError = document.getElementById("scoreError");
    const updatedLabel = document.getElementById("updatedLabel");

    const rankingBody = document.getElementById("rankingBody");
    const emptyRanking = document.getElementById("emptyRanking");
    const summaryInfo = document.getElementById("summaryInfo");
    const top3Container = document.getElementById("top3Container");

    const btnResetRoom = document.getElementById("btnResetRoom");

    // ---- ë Œë”ë§ ------------------------------------------------------------
    function renderPlayerSelect() {
      if (!players.length) {
        playerSelect.innerHTML = '<option value="">ë¨¼ì € í”Œë ˆì´ì–´ë¥¼ ì¶”ê°€í•˜ì„¸ìš”</option>';
        return;
      }
      playerSelect.innerHTML = "";
      const def = document.createElement("option");
      def.value = "";
      def.textContent = "í”Œë ˆì´ì–´ ì„ íƒ";
      playerSelect.appendChild(def);
      players.forEach(p => {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        playerSelect.appendChild(opt);
      });
    }

    function renderRanking() {
      const list = getRankedPlayers();
      rankingBody.innerHTML = "";

      if (!list.length) {
        emptyRanking.style.display = "block";
        summaryInfo.textContent = "-";
        return;
      } else {
        emptyRanking.style.display = "none";
      }

      let totalAvgSum = 0;
      let totalCountWithRounds = 0;

      list.forEach((p, index) => {
        const tr = document.createElement("tr");

        const rankTd = document.createElement("td");
        rankTd.className = "rank-cell";
        rankTd.textContent = p.roundsCount === 0 ? "-" : index + 1;
        tr.appendChild(rankTd);

        const nameTd = document.createElement("td");
        const main = document.createElement("div");
        main.className = "name-main";
        main.textContent = p.name;
        const sub = document.createElement("div");
        sub.className = "name-sub";
        if (p.roundsCount === 0) {
          sub.textContent = "ê¸°ë¡ ì—†ìŒ";
        } else {
          const latest = p.rounds[p.rounds.length - 1];
          const dateText = latest.date || "";
          const labelText = latest.label || "";
          let recentText = "";
          if (dateText || labelText) {
            recentText = ` Â· ìµœê·¼ ${dateText} ${labelText}`.trim();
          }
          sub.textContent = `${p.roundsCount}ë¼ìš´ë“œ${recentText}`;
        }
        nameTd.appendChild(main);
        nameTd.appendChild(sub);
        tr.appendChild(nameTd);

        const avgTd = document.createElement("td");
        avgTd.className = "align-right " + classifyScore(p.avgScore);
        avgTd.textContent = p.roundsCount === 0 ? "-" : p.avgScore.toFixed(1);
        tr.appendChild(avgTd);

        const bestTd = document.createElement("td");
        bestTd.className = "align-right " + classifyScore(p.bestScore);
        bestTd.textContent = p.roundsCount === 0 ? "-" : p.bestScore.toFixed(1);
        tr.appendChild(bestTd);

        const countTd = document.createElement("td");
        countTd.className = "align-right";
        countTd.textContent = p.roundsCount;
        tr.appendChild(countTd);

        rankingBody.appendChild(tr);

        if (p.roundsCount > 0) {
          totalAvgSum += p.avgScore;
          totalCountWithRounds++;
        }
      });

      if (totalCountWithRounds === 0) {
        summaryInfo.textContent = `í”Œë ˆì´ì–´ ${players.length}ëª… Â· ê¸°ë¡ëœ ë¼ìš´ë“œ ì—†ìŒ`;
      } else {
        const overallAvg = totalAvgSum / totalCountWithRounds;
        summaryInfo.textContent = `í”Œë ˆì´ì–´ ${players.length}ëª… Â· í‰ê· ìŠ¤ì½”ì–´(ì „ì²´) ${overallAvg.toFixed(1)}`;
      }
    }

    function renderTop3() {
      const list = getRankedPlayers().filter(p => p.roundsCount > 0);
      if (!list.length) {
        top3Container.innerHTML = '<div class="empty">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ìŠ¤ì½”ì–´ë¥¼ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•´ë³´ì„¸ìš”.</div>';
        return;
      }
      const top3 = list.slice(0, 3);
      const wrapper = document.createElement("div");
      wrapper.className = "top3-list";

      top3.forEach((p, idx) => {
        const item = document.createElement("div");
        item.className = "top3-item";
        const rankDiv = document.createElement("div");
        rankDiv.className = "top3-rank";
        rankDiv.textContent = `No.${idx + 1}`;
        const nameDiv = document.createElement("div");
        nameDiv.className = "top3-name";
        nameDiv.textContent = p.name;
        const scoreDiv = document.createElement("div");
        scoreDiv.className = "top3-score";
        scoreDiv.textContent = `í‰ê·  ${p.avgScore.toFixed(1)} Â· ë² ìŠ¤íŠ¸ ${p.bestScore.toFixed(1)}`;

        const latest = p.rounds[p.rounds.length - 1];
        const roundsDiv = document.createElement("div");
        roundsDiv.style.fontSize = "10px";
        roundsDiv.style.color = "#9ca3af";
        const dateText = latest.date || "";
        const labelText = latest.label || "";
        let recentText = "";
        if (dateText || labelText) {
          recentText = `ìµœê·¼: ${dateText} ${labelText}`.trim();
        }
        roundsDiv.textContent = `${p.roundsCount} ë¼ìš´ë“œ${recentText ? " Â· " + recentText : ""}`;

        item.appendChild(rankDiv);
        item.appendChild(nameDiv);
        item.appendChild(scoreDiv);
        item.appendChild(roundsDiv);
        wrapper.appendChild(item);
      });

      const summaryRow = document.createElement("div");
      summaryRow.className = "summary-row";

      const totalRounds = players.reduce((acc, p) => acc + normalizeRounds(p.rounds).length, 0);
      const pill1 = document.createElement("div");
      pill1.className = "summary-pill";
      pill1.textContent = `í”Œë ˆì´ì–´ ${players.length}ëª…`;
      const pill2 = document.createElement("div");
      pill2.className = "summary-pill";
      pill2.textContent = `ê¸°ë¡ëœ ë¼ìš´ë“œ ${totalRounds}íšŒ`;

      summaryRow.appendChild(pill1);
      summaryRow.appendChild(pill2);

      top3Container.innerHTML = "";
      top3Container.appendChild(wrapper);
      top3Container.appendChild(summaryRow);
    }

    function renderAll() {
      renderPlayerSelect();
      renderRanking();
      renderTop3();
    }

    // ---- Firebase ë™ê¸°í™” ---------------------------------------------------
    let roomRef = null;

    function subscribeRoom(roomCode) {
      if (!roomCode) return;
      if (roomRef) {
        roomRef.off();
      }
      roomRef = db.ref("rooms/" + roomCode);

      roomRef.on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) {
          players = [];
          renderAll();
          updatedLabel.textContent = "-";
          return;
        }
        players = (data.players || []).map(p => ({
          id: p.id,
          name: p.name,
          rounds: normalizeRounds(p.rounds || [])
        }));
        renderAll();
        updatedLabel.textContent = data.lastUpdated || "-";
      });
    }

    function saveRoom() {
      if (!currentRoomCode || !roomRef) return;
      const now = new Date();
      const hh = String(now.getHours()).padStart(2, "0");
      const mm = String(now.getMinutes()).padStart(2, "0");
      const timeStr = `${hh}:${mm}`;
      roomRef.set({
        players,
        lastUpdated: `ë§ˆì§€ë§‰ ì…ë ¥ Â· ${timeStr}`
      });
    }

    // ---- ì´ë²¤íŠ¸ ------------------------------------------------------------
    btnJoinRoom.addEventListener("click", () => {
      const code = roomCodeInput.value.trim();
      roomError.style.display = "none";
      if (!code) {
        roomError.textContent = "ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        roomError.style.display = "block";
        return;
      }
      currentRoomCode = code;
      roomInfo.textContent = `í˜„ì¬ ë°©: ${currentRoomCode}`;
      mainContent.style.opacity = "1";
      mainContent.style.pointerEvents = "auto";

      // ë°© ì…ì¥ ì‹œ êµ¬ë… ì‹œì‘
      subscribeRoom(currentRoomCode);
    });

    btnAddPlayer.addEventListener("click", () => {
      playerError.style.display = "none";
      scoreError.style.display = "none";
      if (!currentRoomCode) {
        playerError.textContent = "ë¨¼ì € ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”.";
        playerError.style.display = "block";
        return;
      }

      const name = playerNameInput.value.trim();
      if (!name) {
        playerError.textContent = "ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        playerError.style.display = "block";
        return;
      }
      const exists = players.some(p => p.name === name);
      if (exists) {
        playerError.textContent = "ì´ë¯¸ ê°™ì€ ì´ë¦„ì˜ í”Œë ˆì´ì–´ê°€ ìˆìŠµë‹ˆë‹¤.";
        playerError.style.display = "block";
        return;
      }
      const newPlayer = {
        id: Date.now().toString(),
        name,
        rounds: []
      };
      players.push(newPlayer);
      saveRoom();
      playerNameInput.value = "";
    });

    btnAddScore.addEventListener("click", () => {
      scoreError.style.display = "none";
      playerError.style.display = "none";
      if (!currentRoomCode) {
        scoreError.textContent = "ë¨¼ì € ë°©ì— ì…ì¥í•´ì£¼ì„¸ìš”.";
        scoreError.style.display = "block";
        return;
      }

      const playerId = playerSelect.value;
      if (!playerId) {
        scoreError.textContent = "í”Œë ˆì´ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
        scoreError.style.display = "block";
        return;
      }

      const rawScore = scoreInput.value.trim();
      if (!rawScore) {
        scoreError.textContent = "ìŠ¤ì½”ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        scoreError.style.display = "block";
        return;
      }
      const score = Number(rawScore);
      if (isNaN(score) || score <= 0) {
        scoreError.textContent = "ì˜¬ë°”ë¥¸ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        scoreError.style.display = "block";
        return;
      }

      const dateValue = roundDateInput.value || getTodayISO();
      const labelValue = roundLabelInput.value.trim();

      const player = players.find(p => p.id === playerId);
      if (!player) {
        scoreError.textContent = "í”Œë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        scoreError.style.display = "block";
        return;
      }

      player.rounds = normalizeRounds(player.rounds);
      player.rounds.push({
        score,
        date: dateValue,
        label: labelValue
      });

      saveRoom();
      scoreInput.value = "";
      if (!roundDateInput.value) {
        roundDateInput.value = getTodayISO();
      }
    });

    btnResetRoom.addEventListener("click", () => {
      if (!currentRoomCode || !roomRef) return;
      const ok = confirm("ì •ë§ ì´ ë°©ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í• ê¹Œìš”?");
      if (!ok) return;
      roomRef.set(null);
    });

    // ì—”í„°í‚¤ í•¸ë“¤ë§
    playerNameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnAddPlayer.click();
    });
    scoreInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnAddScore.click();
    });
    roomCodeInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") btnJoinRoom.click();
    });

    // ì´ˆê¸°ê°’
    roundDateInput.value = getTodayISO();
  </script>
</body>
</html>